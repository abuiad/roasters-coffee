<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>محامص القهوة المختصة - نهائي</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .star { font-size: 1.6rem; cursor: pointer; transition: transform 0.2s, color 0.2s; }
  .star:hover { transform: scale(1.3); color: #facc15; }
  .star.selected { color: #fbbf24; }
  .heart { font-size: 1.6rem; cursor: pointer; transition: transform 0.3s, color 0.3s; }
  .heart.active { color: #ef4444; transform: scale(1.3); }
  .heart.active:hover { transform: scale(1.5); }
  .card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
</style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

<h1 class="text-2xl font-bold text-center mb-4">📍 دليل محامص القهوة المختصة</h1>

<!-- أدوات البحث والفلترة -->
<div class="max-w-5xl mx-auto mb-4 flex flex-col md:flex-row gap-3 justify-between items-center">
<input type="text" id="search" placeholder="🔎 ابحث بالاسم أو المدينة" 
       class="border p-2 rounded-lg w-full md:w-1/3 text-sm">
<select id="sort" class="border p-2 rounded-lg text-sm">
  <option value="">بدون ترتيب</option>
  <option value="name">الترتيب الأبجدي (اسم)</option>
  <option value="city">حسب المدينة</option>
</select>
<div class="flex gap-2">
  <button id="filterAll" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">الكل</button>
  <button id="filterFav" class="px-3 py-1 bg-red-200 rounded hover:bg-red-300 text-sm">المفضلة ❤️</button>
</div>
</div>

<!-- لوحة الإحصائيات -->
<div id="dashboard" class="max-w-5xl mx-auto grid md:grid-cols-4 gap-3 mb-6 text-center text-sm">
  <div class="bg-white shadow rounded-lg p-3">
    <h3 class="text-gray-500">إجمالي المحامص</h3>
    <p id="statTotal" class="text-xl font-bold">0</p>
  </div>
  <div class="bg-white shadow rounded-lg p-3">
    <h3 class="text-gray-500">المفضلة ❤️</h3>
    <p id="statFav" class="text-xl font-bold">0</p>
  </div>
  <div class="bg-white shadow rounded-lg p-3">
    <h3 class="text-gray-500">متوسط التقييم ⭐</h3>
    <p id="statAvgRating" class="text-xl font-bold">0</p>
  </div>
  <div class="bg-white shadow rounded-lg p-3">
    <h3 class="text-gray-500">أكثر مدينة</h3>
    <p id="statTopCity" class="text-lg font-semibold">-</p>
  </div>
</div>

<!-- قائمة المحامص -->
<div id="roastersList" class="grid md:grid-cols-3 gap-4 max-w-5xl mx-auto"></div>

<!-- أزرار الاستيراد والتصدير وإعادة التعيين -->
<div class="max-w-5xl mx-auto mt-6 flex flex-wrap gap-2 justify-center text-sm">
  <button id="exportBtn" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">تصدير JSON</button>
  <input type="file" id="importFile" accept="application/json" class="hidden">
  <label for="importFile" class="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 cursor-pointer">استيراد JSON</label>
  <button id="resetBtn" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">إعادة تعيين</button>
</div>

<!-- نموذج إضافة / تعديل محمصة مصغر أسفل الصفحة -->
<div class="bg-white shadow-xl rounded-xl p-6 max-w-xl mx-auto border-t-4 border-green-600 mt-10">
<h2 class="text-xl font-bold mb-4 flex items-center gap-2">
  ➕ <span id="formTitle">إضافة محمصة جديدة</span>
</h2>
<form id="roasterForm" class="space-y-4 text-sm">
  <input type="hidden" id="roasterId">
  <div class="grid md:grid-cols-2 gap-4">
    <div>
      <label class="block mb-1 font-medium text-gray-700">اسم المحمصة</label>
      <div class="flex items-center border rounded-lg px-2 py-1 bg-gray-50">
        <span class="text-gray-400 mr-2">🏷️</span>
        <input type="text" id="name" required class="w-full bg-transparent outline-none" placeholder="اسم المحمصة">
      </div>
    </div>
    <div>
      <label class="block mb-1 font-medium text-gray-700">المدينة</label>
      <div class="flex items-center border rounded-lg px-2 py-1 bg-gray-50">
        <span class="text-gray-400 mr-2">📍</span>
        <input type="text" id="city" required class="w-full bg-transparent outline-none" placeholder="المدينة">
      </div>
    </div>
  </div>
  <div>
    <label class="block mb-1 font-medium text-gray-700">رابط الموقع</label>
    <div class="flex items-center border rounded-lg px-2 py-1 bg-gray-50">
      <span class="text-gray-400 mr-2">🌐</span>
      <input type="url" id="website" required class="w-full bg-transparent outline-none" placeholder="https://example.com">
    </div>
  </div>
  <div>
    <label class="block mb-1 font-medium text-gray-700">شعار المحمصة</label>
    <input type="file" id="logo" accept="image/*" class="w-full border rounded-lg p-1 shadow-sm">
    <div class="mt-2 text-center">
      <img id="logoPreview" src="https://via.placeholder.com/100?text=Preview" 
           alt="معاينة الشعار" 
           class="w-20 h-20 object-cover rounded-full border border-dashed border-gray-300 mx-auto">
    </div>
  </div>
  <button type="submit" id="submitBtn" 
          class="w-full bg-green-600 text-white py-2 rounded-lg text-sm font-semibold shadow hover:bg-green-700 transition">
    إضافة
  </button>
</form>
</div>

<script>
// ==================== البيانات ====================
let roasters = JSON.parse(localStorage.getItem("roasters")) || [
  {id:Date.now(), name:"محماصة الرياض", city:"الرياض", website:"https://riyadhroastery.com", logo:"", favorite:false, rating:4},
  {id:Date.now()+1, name:"محماصة جدة", city:"جدة", website:"https://jeddahcoffee.com", logo:"", favorite:false, rating:5}
];
let logoBase64 = "";
let showFavoritesOnly = false;

// ==================== LocalStorage ====================
function saveToLocalStorage(){ localStorage.setItem("roasters", JSON.stringify(roasters)); }

// ==================== شعار مع قص ====================
document.getElementById("logo").addEventListener("change", function(){
  const file=this.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image(); img.onload=function(){
      const size=100;
      const canvas=document.createElement("canvas");
      const ctx=canvas.getContext("2d");
      canvas.width=size; canvas.height=size;
      const minSide=Math.min(img.width,img.height);
      const sx=(img.width-minSide)/2, sy=(img.height-minSide)/2;
      ctx.drawImage(img,sx,sy,minSide,minSide,0,0,size,size);
      logoBase64=canvas.toDataURL("image/png");
      document.getElementById("logoPreview").src=logoBase64;
    }; img.src=e.target.result;
  }; reader.readAsDataURL(file);
});

// ==================== إضافة / تعديل ====================
document.getElementById("roasterForm").onsubmit = function(e){
  e.preventDefault();
  const id = document.getElementById("roasterId").value;
  const name = document.getElementById("name").value;
  const city = document.getElementById("city").value;
  const website = document.getElementById("website").value;
  if(id){ roasters = roasters.map(r=>r.id==id?{...r,name,city,website,logo:logoBase64||r.logo}:r); }
  else{ roasters.push({id:Date.now(), name, city, website, logo:logoBase64, favorite:false, rating:0}); }
  saveToLocalStorage(); renderRoasters();
  document.getElementById("roasterForm").reset();
  document.getElementById("roasterId").value=""; logoBase64="";
  document.getElementById("logoPreview").src="https://via.placeholder.com/100?text=Preview";
  document.getElementById("submitBtn").textContent="إضافة";
  document.getElementById("formTitle").textContent="إضافة محمصة جديدة";
};

// ==================== تعديل ====================
function editRoaster(id){
  const r = roasters.find(r=>r.id===id);
  document.getElementById("roasterId").value=r.id;
  document.getElementById("name").value=r.name;
  document.getElementById("city").value=r.city;
  document.getElementById("website").value=r.website;
  document.getElementById("logoPreview").src=r.logo||"https://via.placeholder.com/100?text=Preview";
  logoBase64=r.logo;
  document.getElementById("submitBtn").textContent="تحديث";
  document.getElementById("formTitle").textContent="تعديل المحمصة";
}

// ==================== حذف ====================
function deleteRoaster(id){ if(!confirm("هل تريد حذف هذه المحمصة؟")) return; roasters=roasters.filter(r=>r.id!==id); saveToLocalStorage(); renderRoasters(); }

// ==================== تحديث Dashboard ====================
function updateDashboard(){
  document.getElementById("statTotal").textContent=roasters.length;
  document.getElementById("statFav").textContent=roasters.filter(r=>r.favorite).length;
  document.getElementById("statAvgRating").textContent=roasters.length?(roasters.reduce((sum,r)=>sum+r.rating,0)/roasters.length).toFixed(1):0;
  if(roasters.length){
    const cityCount={}; roasters.forEach(r=>cityCount[r.city]=(cityCount[r.city]||0)+1);
    document.getElementById("statTopCity").textContent=Object.entries(cityCount).sort((a,b)=>b[1]-a[1])[0][0];
  } else { document.getElementById("statTopCity").textContent="-"; }
}

// ==================== إنشاء بطاقة ====================
function renderCard(roaster){
  const card = document.createElement("div");
  card.id = "card-" + roaster.id;
  card.className = "bg-white p-3 rounded-xl shadow flex flex-col items-center gap-2 card";
  card.innerHTML = `
    <img src="${roaster.logo||'https://via.placeholder.com/100?text=Logo'}" class="w-20 h-20 object-cover rounded-full mb-1">
    <h3 class="text-base font-bold">${roaster.name}</h3>
    <p class="text-gray-500 text-sm">${roaster.city}</p>
    <button onclick="window.open('${roaster.website}','_blank')" 
            class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-sm">
      زيارة الموقع 🌐
    </button>
    <div class="stars flex gap-1 mb-1"></div>
    <div class="flex gap-2 mt-1"></div>
  `;
  const starsContainer = card.querySelector(".stars");
  for(let i=1; i<=5; i++){
    const star = document.createElement("span");
    star.textContent="★"; star.className = i<=roaster.rating?"star selected":"star";
    star.onmouseover = ()=> starsContainer.querySelectorAll(".star").forEach((s,idx)=>s.classList.toggle("selected",idx<i));
    star.onmouseout = ()=> starsContainer.querySelectorAll(".star").forEach((s,idx)=>s.classList.toggle("selected",idx<roaster.rating));
    star.onclick = ()=> { roaster.rating=i; saveToLocalStorage(); renderCardById(roaster.id); updateDashboard(); };
    starsContainer.appendChild(star);
  }
  const actions = card.querySelector(".flex.gap-2.mt-1");
  const favBtn = document.createElement("span"); favBtn.className="heart "+(roaster.favorite?"active":""); favBtn.textContent="❤️"; favBtn.onclick=()=>{ roaster.favorite=!roaster.favorite; saveToLocalStorage(); renderCardById(roaster.id); updateDashboard(); }; actions.appendChild(favBtn);
  const editBtn = document.createElement("button"); editBtn.textContent="✏️"; editBtn.className="px-2 py-1 bg-yellow-300 rounded hover:bg-yellow-400 text-sm"; editBtn.onclick=()=>editRoaster(roaster.id); actions.appendChild(editBtn);
  const delBtn = document.createElement("button"); delBtn.textContent="🗑️"; delBtn.className="px-2 py-1 bg-red-300 rounded hover:bg-red-400 text-sm"; delBtn.onclick=()=>deleteRoaster(roaster.id); actions.appendChild(delBtn);
  return card;
}

function renderCardById(id){
  const index = roasters.findIndex(r=>r.id===id); if(index===-1) return;
  const container = document.getElementById("roastersList");
  const oldCard = document.getElementById("card-"+id);
  const newCard = renderCard(roasters[index]);
  if(oldCard) container.replaceChild(newCard, oldCard);
  else container.appendChild(newCard);
}

function renderRoasters(){
  const container = document.getElementById("roastersList"); container.innerHTML="";
  let filtered = roasters;
  const q = document.getElementById("search").value.toLowerCase();
  if(q) filtered = filtered.filter(r=>r.name.toLowerCase().includes(q)||r.city.toLowerCase().includes(q));
  if(showFavoritesOnly) filtered = filtered.filter(r=>r.favorite);
  const sortVal = document.getElementById("sort").value;
  if(sortVal) filtered.sort((a,b)=>a[sortVal].localeCompare(b[sortVal]));
  filtered.forEach(r=>{ container.appendChild(renderCard(r)); });
  updateDashboard();
}

// ==================== البحث + الفرز + الفلترة ====================
document.getElementById("search").oninput = renderRoasters;
document.getElementById("sort").onchange = renderRoasters;
document.getElementById("filterAll").onclick = ()=>{ showFavoritesOnly=false; renderRoasters(); };
document.getElementById("filterFav").onclick = ()=>{ showFavoritesOnly=true; renderRoasters(); };

// ==================== استيراد / تصدير / إعادة التعيين ====================
document.getElementById("exportBtn").onclick=()=>{ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(roasters)],{type:"application/json"})); a.download="roasters.json"; a.click(); };
document.getElementById("importFile").onchange=function(){ const file=this.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=e=>{ roasters=JSON.parse(e.target.result); saveToLocalStorage(); renderRoasters(); }; reader.readAsText(file); };
document.getElementById("resetBtn").onclick=function(){ if(confirm("هل تريد إعادة تعيين كل البيانات؟")){ localStorage.removeItem("roasters"); location.reload(); } };

// ==================== أول رسم ====================
renderRoasters();
</script>
</body>
</html>
